/*
  test case

  1) compile spidermonkey with -DDEBUG 
  2) run program with valgrind or link to efence - to get realloc in jsarena.c:250 to move memory

*/
#include <jsapi.h>
#include <string.h>

JSBool
foo(JSContext *cx, JSObject *obj, uintN argc, jsval *argv, jsval *rval) {
  return JS_TRUE;
}

int
main(int argc, char** argv) 
{
  JSRuntime *rt;
  JSContext *cx;
  JSObject  *glob;
  JSClass global_class = {
    "global",0,
    JS_PropertyStub,JS_PropertyStub,JS_PropertyStub,JS_PropertyStub,
    JS_EnumerateStub,JS_ResolveStub,JS_ConvertStub,JS_FinalizeStub,
    0,0,0,0,0,0,0,0
  };

  if (!(rt = JS_NewRuntime(8L * 1024L * 1024L))) return 1;
  if (!(cx = JS_NewContext(rt, 2<<13))) return 1;
  if (!(glob = JS_NewObject(cx, &global_class, NULL, NULL))) return 1;
  if (!JS_InitStandardClasses(cx, glob)) return 1;
  JS_DefineFunction(cx, glob, "foo", foo, 1, 0);

  char *script="x='--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------';foo(x.toSource());";

  jsval rval;
  JS_EvaluateScript(cx, glob, script, strlen(script), "script", 1, &rval);
  if (cx) {
    JS_DestroyContext(cx);
    cx = NULL;
  }
  if (rt) {
    JS_DestroyRuntime(rt);
    rt = NULL;
  }
  JS_ShutDown();
  return 0;
}
